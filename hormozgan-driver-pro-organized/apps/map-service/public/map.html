<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù‚Ø´Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; }
        #map { height: 100vh; width: 100%; }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-controls">
        <button onclick="findNearbyDrivers()">ğŸ” Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ù†Ø²Ø¯ÛŒÚ©</button>
        <button onclick="showTouristSpots()">ğŸï¸ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Initialize Map
        const map = L.map('map').setView([27.1833, 56.2667], 12);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Socket.io connection
        const socket = io();
        
        // User location marker
        let userMarker;
        let driverMarkers = [];
        let touristMarkers = [];
        
        // Initialize map with user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const { latitude, longitude } = position.coords;
                
                userMarker = L.marker([latitude, longitude])
                    .addTo(map)
                    .bindPopup('Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§')
                    .openPopup();
                
                map.setView([latitude, longitude], 15);
                
                // Send location to server
                socket.emit('map:init', {
                    userId: 'user_' + Date.now(),
                    userType: 'passenger',
                    location: { lat: latitude, lng: longitude }
                });
            });
        }
        
        // Find nearby drivers
        function findNearbyDrivers() {
            const center = map.getCenter();
            socket.emit('map:get-nearby-drivers', {
                lat: center.lat,
                lng: center.lng,
                radius: 2000
            });
        }
        
        // Show tourist spots
        function showTouristSpots() {
            // Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² API Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            const spots = [
                { name: 'Ø¬Ø²ÛŒØ±Ù‡ Ù‡Ø±Ù…Ø²', lat: 27.0598, lng: 56.4767, type: 'island' },
                { name: 'Ø¬Ø²ÛŒØ±Ù‡ Ù‚Ø´Ù…', lat: 26.9478, lng: 56.2721, type: 'island' },
                { name: 'Ø¯Ø±Ù‡ Ø³ØªØ§Ø±Ú¯Ø§Ù†', lat: 26.8583, lng: 55.9167, type: 'nature' }
            ];
            
            // Clear previous markers
            touristMarkers.forEach(marker => map.removeLayer(marker));
            touristMarkers = [];
            
            // Add new markers
            spots.forEach(spot => {
                const marker = L.marker([spot.lat, spot.lng])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${spot.name}</strong><br>
                        Ù†ÙˆØ¹: ${spot.type}<br>
                        <button onclick="navigateToSpot(${spot.lat}, ${spot.lng})">Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</button>
                    `);
                touristMarkers.push(marker);
            });
        }
        
        // Handle nearby drivers response
        socket.on('map:nearby-drivers', (drivers) => {
            // Clear previous markers
            driverMarkers.forEach(marker => map.removeLayer(marker));
            driverMarkers = [];
            
            // Add driver markers
            drivers.forEach(driver => {
                const marker = L.marker([driver.location[0], driver.location[1]], {
                    icon: L.divIcon({
                        className: 'driver-marker',
                        html: 'ğŸš—',
                        iconSize: [30, 30]
                    })
                })
                .addTo(map)
                .bindPopup(`
                    <strong>${driver.name}</strong><br>
                    â­ ${driver.rating}<br>
                    ğŸ• ${driver.eta}<br>
                    <button onclick="requestRide(${driver.id})">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ±</button>
                `);
                driverMarkers.push(marker);
            });
        });
        
        // Navigation function
        function navigateToSpot(lat, lng) {
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                
                // Add route line (Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
                const route = L.polyline([
                    [userLatLng.lat, userLatLng.lng],
                    [lat, lng]
                ], { color: 'blue' }).addTo(map);
                
                // Calculate distance
                const distance = map.distance(userLatLng, L.latLng(lat, lng));
                alert(`ÙØ§ØµÙ„Ù‡ ØªØ§ Ù…Ù‚ØµØ¯: ${Math.round(distance)} Ù…ØªØ±`);
            }
        }
        
        // Request ride
        function requestRide(driverId) {
            alert(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡ ${driverId} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
            // Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ù‡ API Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }
        
        // Real-time location updates
        socket.on('user:moved', (data) => {
            console.log('User moved:', data);
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø³Ø§ÛŒØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        });
    </script>
</body>
</html>
