name: CI/CD Pipeline
on:
push:
branches: [ main, develop ]
pull_request:
branches: [ main, develop ]
jobs:
test:
runs-on: ubuntu-latest
steps:
- name: Checkout کد
  uses: actions/checkout@v4
  
- name: نصب Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '18'
    cache: 'npm'

- name: نصب dependencies
  run: npm ci
  
- name: Build کردن پروژه
  run: npm run build
  
- name: اجرای تست‌ها
  run: npm test
  
- name: بررسی کیفیت کد (Lint)
  run: npm run lint --if-present
docker-build:
runs-on: ubuntu-latest
needs: test
if: github.ref == 'refs/heads/main'
steps:
- name: Checkout
  uses: actions/checkout@v4
  
- name: لاگین به Docker Hub
  uses: docker/login-action@v3
  with:
    username: ${{ secrets.DOCKER_USERNAME }}
    password: ${{ secrets.DOCKER_PASSWORD }}

- name: Build و Push Docker Image
  uses: docker/build-push-action@v5
  with:
    context: .
    push: true
    tags: |
      hormozgandriver/api:latest
      hormozgandriver/api:${{ github.sha }}
